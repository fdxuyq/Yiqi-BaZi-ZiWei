/**
 * 十二长生（星运）算法
 * 
 * 十二长生是命理学中描述五行在十二地支中的旺衰状态，包括：
 * 长生、沐浴、冠带、临官、帝旺、衰、病、死、墓、绝、胎、养
 * 
 * 根据日干的五行属性，查找其在各地支的长生状态
 */

import type { Tiangan, Dizhi } from './types';

/**
 * 十二长生状态
 */
export type ChangSheng =
  | '长生' | '沐浴' | '冠带' | '临官' | '帝旺' | '衰'
  | '病' | '死' | '墓' | '绝' | '胎' | '养';

/**
 * 十二长生映射表
 * 根据天干十二长生表（见附件图片）
 * 
 * 阳干（甲丙戊庚壬）：顺行
 * 阴干（乙丁己辛癸）：逆行
 */
const CHANGSHENG_MAP: Record<Tiangan, Record<Dizhi, ChangSheng>> = {
  '甲': {
    '亥': '长生', '子': '沐浴', '丑': '冠带', '寅': '临官',
    '卯': '帝旺', '辰': '衰', '巳': '病', '午': '死',
    '未': '墓', '申': '绝', '酉': '胎', '戌': '养'
  },
  '乙': {
    '午': '长生', '巳': '沐浴', '辰': '冠带', '卯': '临官',
    '寅': '帝旺', '丑': '衰', '子': '病', '亥': '死',
    '戌': '墓', '酉': '绝', '申': '胎', '未': '养'
  },
  '丙': {
    '寅': '长生', '卯': '沐浴', '辰': '冠带', '巳': '临官',
    '午': '帝旺', '未': '衰', '申': '病', '酉': '死',
    '戌': '墓', '亥': '绝', '子': '胎', '丑': '养'
  },
  '丁': {
    '酉': '长生', '申': '沐浴', '未': '冠带', '午': '临官',
    '巳': '帝旺', '辰': '衰', '卯': '病', '寅': '死',
    '丑': '墓', '子': '绝', '亥': '胎', '戌': '养'
  },
  '戊': {
    '寅': '长生', '卯': '沐浴', '辰': '冠带', '巳': '临官',
    '午': '帝旺', '未': '衰', '申': '病', '酉': '死',
    '戌': '墓', '亥': '绝', '子': '胎', '丑': '养'
  },
  '己': {
    '酉': '长生', '申': '沐浴', '未': '冠带', '午': '临官',
    '巳': '帝旺', '辰': '衰', '卯': '病', '寅': '死',
    '丑': '墓', '子': '绝', '亥': '胎', '戌': '养'
  },
  '庚': {
    '巳': '长生', '午': '沐浴', '未': '冠带', '申': '临官',
    '酉': '帝旺', '戌': '衰', '亥': '病', '子': '死',
    '丑': '墓', '寅': '绝', '卯': '胎', '辰': '养'
  },
  '辛': {
    '子': '长生', '亥': '沐浴', '戌': '冠带', '酉': '临官',
    '申': '帝旺', '未': '衰', '午': '病', '巳': '死',
    '辰': '墓', '卯': '绝', '寅': '胎', '丑': '养'
  },
  '壬': {
    '申': '长生', '酉': '沐浴', '戌': '冠带', '亥': '临官',
    '子': '帝旺', '丑': '衰', '寅': '病', '卯': '死',
    '辰': '墓', '巳': '绝', '午': '胎', '未': '养'
  },
  '癸': {
    '卯': '长生', '寅': '沐浴', '丑': '冠带', '子': '临官',
    '亥': '帝旺', '戌': '衰', '酉': '病', '申': '死',
    '未': '墓', '午': '绝', '巳': '胎', '辰': '养'
  }
};

/**
 * 获取天干在某地支的长生状态
 * @param tiangan 天干
 * @param dizhi 地支
 * @returns 长生状态（长生、沐浴、冠带等）
 */
export function getChangSheng(tiangan: Tiangan, dizhi: Dizhi): ChangSheng {
  return CHANGSHENG_MAP[tiangan][dizhi];
}

/**
 * 批量获取四柱的长生状态
 * @param dayGan 日干
 * @param siZhu 四柱地支
 * @returns 四柱长生状态数组
 */
export function getSiZhuChangSheng(
  dayGan: Tiangan,
  siZhu: { year: Dizhi; month: Dizhi; day: Dizhi; hour: Dizhi }
): {
  year: ChangSheng;
  month: ChangSheng;
  day: ChangSheng;
  hour: ChangSheng;
} {
  return {
    year: getChangSheng(dayGan, siZhu.year),
    month: getChangSheng(dayGan, siZhu.month),
    day: getChangSheng(dayGan, siZhu.day),
    hour: getChangSheng(dayGan, siZhu.hour)
  };
}

/**
 * 判断长生状态的吉凶
 * @param changsheng 长生状态
 * @returns 吉凶等级（1-5，5最吉）
 */
export function getChangShengLevel(changsheng: ChangSheng): number {
  const levels: Record<ChangSheng, number> = {
    '长生': 5, // 最吉
    '帝旺': 5, // 最吉
    '临官': 4, // 次吉
    '冠带': 4, // 次吉
    '养': 3,   // 平
    '胎': 3,   // 平
    '沐浴': 2, // 次凶（桃花）
    '衰': 2,   // 次凶
    '病': 1,   // 凶
    '死': 1,   // 凶
    '墓': 1,   // 凶
    '绝': 1    // 最凶
  };
  return levels[changsheng];
}
