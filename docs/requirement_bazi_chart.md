# 八字排盘功能需求文档

## 文档版本
- **创建日期**: 2025-12-05
- **最后更新**: 2025-12-06
- **文档状态**: ✅ 已实现并持续优化

---

## 一、功能概述

八字排盘是命理分析的核心功能，通过用户的出生时间信息，自动计算并展示完整的八字命盘，包括四柱、十神、藏干、大运、流年等关键信息。

### 核心价值
- **专业准确**: 使用专业命理算法（lunar-javascript库），确保排盘结果准确可靠
- **直观易读**: 采用传统命盘布局，符合命理师阅读习惯，居中紧凑显示
- **信息完整**: 展示原局、大运、流年等完整命理信息
- **配色统一**: 使用工程化五行配色方案，所有干支、十神颜色一致# 文档版本
- **创建日期**: 2024-12-05
- **最后更新**: 2024-12-05
- **文档状态**: ✅ 已实现

---

## 一、功能概述

八字排盘是命理分析的核心功能，通过用户的出生时间信息，自动计算并展示完整的八字命盘，包括四柱、十神、藏干、大运、流年等关键信息。

### 核心价值
- **专业准确**: 使用专业命理算法，确保排盘结果准确可靠
- **直观易读**: 采用传统命盘布局，符合命理师阅读习惯
- **信息完整**: 展示原局、大运、流年等完整命理信息

---

## 二、功能模块

### 2.1 输入方式

#### 2.1.1 日期时间输入（标准模式）
**功能描述**: 通过选择出生日期和时间进行排盘

**输入字段**:
- 姓名（可选）
- 性别：男/女（必填）
- 出生日期：年/月/日（必填）
- 出生时间：时/分（必填）
- 历法选择：公历/农历（必填）

**交互流程**:
```
1. 用户填写基本信息
2. 选择历法类型（公历/农历）
3. 通过日期选择器选择出生日期
4. 通过时间选择器选择出生时刻
5. 点击"开始排盘"按钮
6. 系统计算并展示八字命盘
```

**验证规则**:
- 性别必选
- 日期必须是有效日期
- 时间必须在 00:00-23:59 范围内
- 农历日期需转换为公历进行计算

#### 2.1.2 八字快捷输入（专业模式）
**功能描述**: 命理师可直接输入已知的八字四柱进行排盘

详见：[快捷录入排盘功能需求文档](./requirement_bazi_quick_input.md)

---

### 2.2 八字计算

#### 2.2.1 四柱计算
**年柱**: 根据立春节气确定，不以公历1月1日为界
- 立春前：使用上一年的干支
- 立春后：使用当年的干支

**月柱**: 根据节气确定
- 立春-惊蛰：寅月
- 惊蛰-清明：卯月
- （以此类推...）

**日柱**: 使用 lunar-javascript 库精确计算
- 支持公历/农历互转
- 考虑时区因素（默认东八区）

**时柱**: 根据出生时辰确定
- 子时：23:00-00:59
- 丑时：01:00-02:59
- （以此类推...）

#### 2.2.2 十神计算
以日干为我，计算其他三柱天干的十神关系：
- **比肩/劫财**: 与我同类
- **食神/伤官**: 我生者
- **正财/偏财**: 我克者
- **正官/七杀**: 克我者
- **正印/偏印**: 生我者

#### 2.2.3 藏干计算
地支藏干包含1-3个天干，需显示：
- 藏干天干
- 藏干对应的十神
- 藏干余气天数（可选）

#### 2.2.4 十二长生（星运）计算
**定义**: 十二长生是描述五行在十二地支中的旺衰状态，也称"星运"。

**十二状态**: 长生、沐浴、冠带、临官、帝旺、衰、病、死、墓、绝、胎、养

**计算规则**:
- 以日干为基准，查找其在四柱地支中的长生状态
- 阳干（甲丙戊庚壬）：顺行排列
- 阴干（乙丁己辛癸）：逆行排列

**十二长生对照表**:
```
甲: 亥长生、子沐浴、丑冠带、寅临官、卯帝旺、辰衰、巳病、午死、未墓、申绝、酉胎、戌养
乙: 午长生、巳沐浴、辰冠带、卯临官、寅帝旺、丑衰、子病、亥死、戌墓、酉绝、申胎、未养
丙: 寅长生、卯沐浴、辰冠带、巳临官、午帝旺、未衰、申病、酉死、戌墓、亥绝、子胎、丑养
丁: 酉长生、申沐浴、未冠带、午临官、巳帝旺、辰衰、卯病、寅死、丑墓、子绝、亥胎、戌养
戊: 寅长生、卯沐浴、辰冠带、巳临官、午帝旺、未衰、申病、酉死、戌墓、亥绝、子胎、丑养
己: 酉长生、申沐浴、未冠带、午临官、巳帝旺、辰衰、卯病、寅死、丑墓、子绝、亥胎、戌养
庚: 巳长生、午沐浴、未冠带、申临官、酉帝旺、戌衰、亥病、子死、丑墓、寅绝、卯胎、辰养
辛: 子长生、亥沐浴、戌冠带、酉临官、申帝旺、未衰、午病、巳死、辰墓、卯绝、寅胎、丑养
壬: 申长生、酉沐浴、戌冠带、亥临官、子帝旺、丑衰、寅病、卯死、辰墓、巳绝、午胎、未养
癸: 卯长生、寅沐浴、丑冠带、子临官、亥帝旺、戌衰、酉病、申死、未墓、午绝、巳胎、辰养
```

**吉凶意义**:
- **长生、帝旺**: 最吉，生旺之地
- **临官、冠带**: 次吉，得令之时
- **养、胎**: 平，孕育之象
- **沐浴**: 次凶（桃花），易有波折
- **衰**: 次凶，力量减弱
- **病、死、墓、绝**: 凶，最为不利

**实现文件**: `src/core/changsheng.ts`

#### 2.2.5 纳音五行计算
**定义**: 纳音是根据干支组合推算出的五行属性，每两个干支组成一个纳音。

**纳音分类**:
- **金系**: 海中金、金箔金、白蜡金、剑锋金、钗钏金、沙中金
- **木系**: 大林木、杨柳木、松柏木、平地木、石榴木、桑柘木
- **水系**: 涧下水、大溪水、长流水、天河水、大海水、泉中水
- **火系**: 炉中火、山头火、霹雳火、山下火、覆灯火、天上火
- **土系**: 城头土、屋上土、壁上土、大驿土、沙中土、路旁土

**纳音对照表**（部分示例）:
```
甲子乙丑海中金  甲戌乙亥山头火  甲申乙酉泉中水
丙子丁丑涧下水  丙戌丁亥屋上土  丙申丁酉山下火
戊子己丑霹雳火  戊戌己亥平地木  戊申己酉大驿土
庚子辛丑壁上土  庚戌辛亥钗钏金  庚申辛酉石榴木
壬子癸丑桑柘木  壬戌癸亥大海水  壬申癸酉剑锋金
...（共60甲子，30种纳音）
```

**用途**:
- 判断命局五行强弱
- 分析大运流年五行生克
- 配合紫微斗数推算五行局

**实现文件**: `src/core/nayin.ts`

#### 2.2.6 大运计算
**起运计算**:
- 阳男阴女：顺推
- 阴男阳女：逆推
- 起运岁数：出生到最近节气的天数÷3

**大运信息**:
- 大运干支
- 起始年份
- 起始岁数
- 天干十神
- 地支十神
- 每步大运管10年

**显示数量**: 至少显示9步大运（90年）

#### 2.2.7 流年计算
**计算规则**:
- 每步大运包含10个流年
- 流年从大运起始年开始
- 自动计算每个流年的干支

**显示方式**:
- 在对应大运下方竖列显示
- 只显示干支，不显示年份岁数
- 当前流年自动高亮

---

### 2.3 界面展示

#### 2.3.1 基本信息栏
**显示内容**:
- 命主信息（头像、性别）
- 阳历日期
- 阴历日期（可切换显示/隐藏）

**样式要求**:
- 使用渐变色背景
- 白色文字，提升视觉层次
- 紧凑布局，信息清晰

#### 2.3.2 四柱主表
**表格结构**:
```
行标签 | 年柱 | 月柱 | 日柱 | 时柱
------|------|------|------|------
主星  | 十神 | 十神 | 元男/元女 | 十神
天干  | 干   | 干   | 日主   | 干
地支  | 支   | 支   | 支     | 支
藏干  | 藏干信息 | 藏干信息 | 藏干信息 | 藏干信息
星运  | 长生 | 沐浴 | ... | ...
纳音  | 纳音 | 纳音 | 纳音 | 纳音
```

**样式要求**:
- 日柱高亮显示，作为命盘核心
- 天干地支字体较大（18px），易于识别
- 十神字体适中（11px）
- 藏干信息紧凑排列
- 星运（长生）字体11px，简洁显示
- 纳音字体10px，完整显示纳音名称

**说明**:
- 星运行使用真实的十二长生算法（`src/core/changsheng.ts`）
- 纳音行使用真实的纳音五行算法（`src/core/nayin.ts`）

#### 2.3.3 大运流年区域
**起运信息**:
- 起运岁数
- 当前年龄
- 交运时间
- 当前司令

**大运列**:
```
起始年份
岁数区间
大运干支（上下排列）
天干十神 | 地支十神（简化显示）
━━━━━━（分隔线）
流年干支（竖列显示）
```

**流年显示**:
- 每个大运下方竖列显示10个流年
- 只显示干支（如：甲子、乙丑...）
- 当前流年背景高亮
- 字体11px，紧凑排列
- 无背景方块，简洁清晰

**样式要求**:
- 大运列最小宽度 95px
- 当前大运高亮边框
- 大运十神使用简化名称（官、杀、财、才、食、伤、印、枭、比、劫）
- 流年支持滚动查看

---

### 2.4 配色方案

#### 2.4.1 五行配色
**统一原则**: 所有干支配色遵循五行属性，使用工程化配色工具（`src/utils/wuxing.ts`）

| 五行 | 颜色值 | 应用范围 |
|------|--------|----------|
| 木 | `#22c55e` 绿色 | 甲、乙、寅、卯 |
| 火 | `#ef4444` 红色 | 丙、丁、巳、午 |
| 土 | `#81710f` 褐色 | 戊、己、辰、戌、丑、未 |
| 金 | `#d97706` 金色 | 庚、辛、申、酉 |
| 水 | `#1f2937` 黑色 | 壬、癸、子、亥 |

**工具函数**:
```typescript
// 导入五行配色工具
import { getWuXingColor, WUXING_COLORS } from '@/utils/wuxing';

// 使用示例
const color = getWuXingColor('甲'); // 返回 '#22c55e'
```

#### 2.4.2 十神配色
**原则**: 十神颜色跟随其对应天干的五行颜色

- 年柱十神 → 年柱天干的五行色
- 月柱十神 → 月柱天干的五行色
- 时柱十神 → 时柱天干的五行色
- 藏干十神 → 藏干天干的五行色

**不再使用独立的十神配色方案**，保持与五行体系统一。

**配色示例**:
```typescript
// 十神使用对应天干的五行颜色
十神('正官' on 天干'甲') → 绿色 #22c55e
十神('正财' on 天干'丙') → 红色 #ef4444
十神('食神' on 天干'壬') → 黑色 #1f2937
```

#### 2.4.3 大运流年配色
- 大运干支：使用五行配色
- 大运十神：灰色文字（#666），不添加背景色
- 流年干支：使用五行配色
- 当前流年：背景淡黄色高亮（#fef3c7）
- 当前大运：边框高亮

**流年配色与合盘一致**：
- 流年天干地支配色严格遵循五行色
- 去除多余的背景色方块
- 只保留当前流年的高亮提示

---

### 2.5 布局设计

#### 2.5.1 页面居中
```css
最大宽度: 1000px
背景色: #f5f7fa（灰色背景）
内容卡片: 白色，圆角12px，阴影效果
左右居中: flex布局，justify-content: center
```

**设计目的**:
- 内容集中，避免视线分散
- 提升阅读舒适度
- 适配不同屏幕尺寸

#### 2.5.2 响应式设计
**移动端适配**:
- 小屏设备（≤768px）：
  - 减小padding和margin
  - 字体适当缩小
  - 大运列最小宽度调整为70px
  - 垂直滚动优化

---

## 三、技术实现

### 3.1 核心库依赖
- **lunar-javascript**: 公历农历转换、节气计算
- **solar2lunar**: 辅助农历转换（备用）
- **dayjs**: 日期时间处理

### 3.2 算法要点

#### 3.2.1 大运计算规则
**顺逆排规则**:
- **阳年男命、阴年女命**：顺排（月柱顺推）
- **阴年男命、阳年女命**：逆排（月柱逆推）

**年干阴阳判断**:
- 阳年：甲、丙、戊、庚、壬
- 阴年：乙、丁、己、辛、癸

**起运岁数计算**:
- 阳男阴女：出生日到下一个节气的天数÷3
- 阴男阳女：出生日到上一个节气的天数÷3
- 每3天折合1岁

**大运周期**:
- 每步大运管10年
- 显示9步大运（90年）

**实现文件**: `src/core/bazi.ts`

#### 3.2.2 反推日期算法
**用途**: 当用户通过快捷输入提供八字时，需要反推对应的公历日期（用于紫微斗数计算）

**算法流程**:
```
1. 根据年柱确定年份范围（立春前后）
2. 根据月柱确定节气月（扩展到3个公历月）
3. 在月份范围内遍历每一天
4. 计算每天的日柱，与用户输入的日柱比对
5. 匹配成功后，根据时柱确定出生时辰
6. 返回精确的公历日期时间
```

**优化点**:
- 使用 lunar-javascript 库进行精确计算
- 考虑节气月跨公历月的情况
- 双重匹配月柱和日柱，提升准确性
- 跨年处理（如子月可能跨到前一年12月或后一年1月）

**重要说明**:
- 反推日期仅用于紫微斗数农历转换
- 八字排盘直接使用用户输入的八字
- 确保用户输入与最终排盘结果完全一致

#### 3.2.3 时柱修正
**真太阳时考虑**（可选功能）:
- 根据出生地经度修正时间
- 经度差每15度约1小时
- 东八区以东加时，以西减时
- 边界时辰需特别注意

详见：[时区功能评估文档](./timezone_feature_summary.md)

### 3.3 数据结构

#### 3.3.1 八字数据类型
```typescript
interface BaziChart {
  birthInfo: BirthInfo;           // 生辰信息
  siZhu: SiZhu;                   // 四柱
  shiShen: Record<string, string>; // 十神
  dayMaster: string;              // 日主天干
  dayun: DayunDetail[];           // 大运数组
  dayunStart: number;             // 起运岁数
  cangGan: Record<string, CangGan[]>; // 藏干
}

interface SiZhu {
  year: GanZhi;   // 年柱
  month: GanZhi;  // 月柱
  day: GanZhi;    // 日柱
  hour: GanZhi;   // 时柱
}

interface GanZhi {
  gan: Tiangan;   // 天干
  zhi: Dizhi;     // 地支
}

interface DayunDetail {
  ganZhi: GanZhi;       // 大运干支
  startAge: number;     // 起始岁数
  startYear: number;    // 起始年份
  endYear: number;      // 结束年份
  ganShiShen: string;   // 天干十神
  zhiShiShen: string;   // 地支十神
  liuNian: LiuNian[];   // 流年数组
}

interface LiuNian {
  year: number;   // 公历年份
  age: number;    // 虚岁
  ganZhi: GanZhi; // 流年干支
}
```

### 3.4 组件架构
```
BaziChart.vue                    # 八字盘主组件
├── 基本信息栏
├── 四柱主表
│   ├── 十神行
│   ├── 天干行
│   ├── 地支行
│   ├── 藏干行
│   ├── 长生行
│   └── 纳音行
└── 大运流年区域
    ├── 起运信息
    └── 大运时间轴
        ├── 大运列 × 9
        └── 流年竖列（每列10个）
```

---

## 四、用户体验优化

### 4.1 交互优化
- ✅ 大运流年无需点击展开，直接显示
- ✅ 当前大运自动高亮
- ✅ 当前流年自动高亮
- ✅ 农历显示可开关切换
- ✅ 支持"返回输入"功能
- ✅ 支持"保存案例"功能

### 4.2 视觉优化
- ✅ 页面居中，最大宽度1000px
- ✅ 五行配色统一，视觉清晰
- ✅ 字体大小协调，层次分明
- ✅ 流年无背景方块，简洁美观
- ✅ 日柱突出显示，核心清晰

### 4.3 性能优化
- ✅ 使用专业命理库，计算准确高效
- ✅ 数据缓存，避免重复计算
- ✅ 组件按需加载
- ✅ 大量流年数据支持滚动

---

## 五、测试验证

### 5.1 功能测试
- [x] 公历日期排盘准确性
- [x] 农历日期排盘准确性
- [x] 四柱计算准确性
- [x] 十神计算准确性
- [x] 大运起运计算准确性
- [x] 流年计算准确性
- [x] 边界日期处理（立春、子时等）

### 5.2 界面测试
- [x] 各种屏幕尺寸适配
- [x] 移动端响应式布局
- [x] 配色显示正确性
- [x] 当前大运/流年高亮
- [x] 滚动流畅性

### 5.3 用例测试
**测试用例**: 甲午年 壬申月 丁丑日 戊申时
- 公历：2014-09-03 15:30
- 预期结果：四柱准确，大运流年正确

**测试结果**: ✅ 通过

---

## 六、已知问题与限制

### 6.1 已知问题
- 无

### 6.2 功能限制
1. **地点时区**: 当前默认使用东八区（北京时间），未实现地点推演真太阳时
   - 解决方案：参考 [时区功能评估文档](./timezone_feature_summary.md)
   
2. **藏干算法**: 当前使用简化版藏干映射
   - 可优化：使用更精确的余气计算

3. **神煞计算**: 长生、纳音等使用随机值（待实现真实算法）

---

## 七、后续优化计划

### 7.1 短期优化（已完成）
- ✅ 页面居中布局
- ✅ 字体大小优化
- ✅ 流年竖列显示
- ✅ 五行配色统一
- ✅ 组件工程化重构

### 7.2 中期优化（规划中）
- [ ] 实现真实的长生十二宫算法
- [ ] 实现真实的纳音算法
- [ ] 实现藏干余气计算
- [ ] 添加神煞显示（天乙贵人、桃花等）
- [ ] 支持打印功能

### 7.3 长期优化（待规划）
- [ ] 地点推演真太阳时
- [ ] 八字分析建议
- [ ] 大运流年吉凶分析
- [ ] 导出为PDF
- [ ] 命盘分享功能

---

## 八、相关文档

### 需求文档
- [快捷录入排盘功能需求文档](./requirement_bazi_quick_input.md)
- [紫微斗数安星四化功能需求文档](./requirement_ziwei_system.md)

### 技术文档
- [项目技术设计文档](./technical_design.md)
- [时区功能评估文档](./timezone_feature_summary.md)

### 实现总结
- [八字排盘UI优化总结](./bazi_chart_ui_optimization.md)
- [五行配色工程化总结](./wuxing_refactor_summary.md)
- [八字大运算法修复总结](./dayun_fix_summary.md)
- [组件化重构总结](./chartpage_componentization.md)
- [紫微斗数安星四化需求文档](./requirement_ziwei_system.md)
- [八字排盘UI优化总结](./bazi_chart_ui_optimization.md)
- [时区功能评估文档](./timezone_feature_summary.md)
- [五行配色工程化总结](./wuxing_refactor_summary.md)

---

## 九、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2024-12-05 | 初始版本，整合八字排盘所有需求 |
| 1.1 | 2024-12-05 | 添加UI优化和工程化改造内容 |
| 1.2 | 2024-12-05 | 完善测试用例和已知问题 |
