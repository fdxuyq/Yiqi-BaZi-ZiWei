# 紫微斗数安星四化功能需求文档

## 文档版本
- **创建日期**: 2025-12-05
- **最后更新**: 2025-12-06
- **文档状态**: ✅ 已实现（持续优化中）

---

## 一、功能概述

紫微斗数是中国传统命理学的重要分支，通过安星布局、四化分析等方法，推算人生运势、性格特点、事业财运等。本系统实现完整的紫微斗数排盘功能，包括主星安排、辅星安排、四化系统、大限流年等。

### 核心价值
- **系统完整**: 实现紫微斗数完整的安星体系（108颗星）
- **算法准确**: 严格遵循紫微斗数传统算法
- **四化精准**: 实现本命、大限、流年四化分析
- **自化识别**: 识别并标注自化星曜（自化禄/权/科/忌）
- **大限流年**: 完整计算大限流年，自动标注当前大限

---

## 二、功能模块

### 2.1 基础计算

#### 2.1.1 命盘格局
**五行局计算**:
- 根据出生年份的纳音确定五行局
- 五行局决定紫微星和其他主星的位置
- 五行局类型：
  - 水二局、木三局、金四局
  - 土五局、火六局

**起盘信息**:
- 出生年月日时（农历）
- 性别：男/女
- 五行局
- 命宫位置
- 身宫位置

#### 2.1.2 十二宫位
**宫位顺序**（逆时针）:
```
巳 午 未 申
辰     酉
卯     戌
寅 丑 子 亥
```

**宫位名称**:
1. 命宫：本命核心，命主性格
2. 兄弟宫：手足关系
3. 夫妻宫：婚姻感情
4. 子女宫：子女缘分
5. 财帛宫：财运状况
6. 疾厄宫：健康状况
7. 迁移宫：外出运势
8. 交友宫（奴仆宫）：人际关系
9. 官禄宫（事业宫）：事业发展
10. 田宅宫：不动产
11. 福德宫：精神享受
12. 父母宫：父母长辈

**特殊宫位**:
- 身宫：与命宫配合，影响后半生
- 来因宫：前世因缘

---

### 2.2 主星系统

#### 2.2.1 北斗星系
**紫微星**（帝座之星）:
- 根据五行局和出生日确定位置
- 顺时针排列

**天机星**（智慧之星）:
- 紫微星顺行

**太阳星**（权贵之星）:
- 从寅宫起，顺时针排列
- 庙旺平陷有别

**武曲星**（财星）:
- 紫微星逆行

**天同星**（福星）:
- 紫微星顺行

**廉贞星**（囚星）:
- 紫微星顺行

#### 2.2.2 南斗星系
**天府星**（财库之星）:
- 与紫微星相对的宫位

**太阴星**（财星、妻星）:
- 从酉宫起，逆时针排列
- 庙旺平陷有别

**贪狼星**（桃花星）:
- 天府星顺行

**巨门星**（暗星）:
- 天府星顺行

**天相星**（印星）:
- 天府星顺行

**天梁星**（荫星）:
- 天府星顺行

**七杀星**（将星）:
- 天府星顺行

#### 2.2.3 中天星系
**破军星**（耗星）:
- 与禄存星有关联

**文昌星**（科甲之星）:
- 从寅宫起，根据时辰安排

**文曲星**（科甲之星）:
- 从戌宫起，根据时辰安排

---

### 2.3 辅星系统

#### 2.3.1 六吉星
1. **左辅星**: 从辰宫起，顺时针根据月份安排
2. **右弼星**: 从戌宫起，逆时针根据月份安排
3. **天魁星**: 根据年干安排
4. **天钺星**: 根据年干安排
5. **文昌星**: 根据时辰安排
6. **文曲星**: 根据时辰安排

#### 2.3.2 六煞星
1. **火星**: 根据年支和时辰安排
2. **铃星**: 根据年支和时辰安排
3. **擎羊星**: 根据年干安排
4. **陀罗星**: 根据年干安排
5. **地空星**: 根据时辰安排
6. **地劫星**: 根据时辰安排

#### 2.3.3 四化星
**禄存星**: 根据年干安排，代表财禄
**天马星**: 根据年支安排，代表动荡

#### 2.3.4 其他辅星
- **天空、天刑、天姚、天哭、天虚**等
- **红鸾、天喜、咸池、天德**等
- **孤辰、寡宿、截空、旬空**等

**总计**: 108颗星（包括主星、辅星、杂曜）

---

### 2.4 四化系统

#### 2.4.1 四化概述
**四化**是紫微斗数的核心，代表星曜的变化：
- **化禄**: 增加吉利、财富
- **化权**: 增加权力、控制
- **化科**: 增加名誉、才华
- **化忌**: 增加困扰、阻碍

#### 2.4.2 四化类型

##### 2.4.2.1 本命四化（生年四化）
根据**出生年份的天干**确定：

| 年干 | 化禄 | 化权 | 化科 | 化忌 |
|------|------|------|------|------|
| 甲 | 廉贞 | 破军 | 武曲 | 太阳 |
| 乙 | 天机 | 天梁 | 紫微 | 太阴 |
| 丙 | 天同 | 天机 | 文昌 | 廉贞 |
| 丁 | 太阴 | 天同 | 天机 | 巨门 |
| 戊 | 贪狼 | 太阴 | 右弼 | 天机 |
| 己 | 武曲 | 贪狼 | 天梁 | 文曲 |
| 庚 | 太阳 | 武曲 | 太阴 | 天同 |
| 辛 | 巨门 | 太阳 | 文曲 | 文昌 |
| 壬 | 天梁 | 紫微 | 左辅 | 武曲 |
| 癸 | 破军 | 巨门 | 太阴 | 贪狼 |

**特点**:
- 一生不变
- 影响命主整体性格和运势
- 是紫微斗数分析的基础

##### 2.4.2.2 大限四化
**计算规则**:
- 根据**当前大限所在宫位的天干**确定
- 每个大限（10年）有不同的四化
- 影响该10年的运势变化

**大限起算**:
- 阳男阴女：顺行
- 阴男阳女：逆行
- 每步大限管10年

**示例**:
```
命宫在寅宫（天干为甲）
第一大限（1-10岁）：甲的四化
第二大限（11-20岁）：卯宫天干的四化
...
```

##### 2.4.2.3 流年四化
**计算规则**:
- 根据**流年的天干**确定
- 每年不同
- 影响当年的运势

**流年范围**:
- 通常显示当前年份前后各若干年
- 与大限配合分析

#### 2.4.3 自化
**定义**: 当某宫位的主星被该宫位自身的天干四化时，称为自化。

**类型**:
- **自化禄**: 该宫位的主星被本宫天干化禄
- **自化权**: 该宫位的主星被本宫天干化权
- **自化科**: 该宫位的主星被本宫天干化科
- **自化忌**: 该宫位的主星被本宫天干化忌（最凶）

**意义**:
- 自化表示能量内部循环
- 自化禄/权/科：吉中有制，需要努力
- 自化忌：凶上加凶，最忌讳

**显示方式**:
- 在星曜后添加特殊标记，如"武曲(自化禄)"

#### 2.4.4 四化叠加规则
**叠加情况**:
- 本命四化 + 大限四化
- 本命四化 + 流年四化
- 大限四化 + 流年四化
- 三重叠加（本命 + 大限 + 流年）

**显示优先级**:
```
1. 本命四化（红色/粗体）
2. 大限四化（蓝色）
3. 流年四化（绿色）
4. 叠加显示（多个标签）
```

**分析重点**:
- 三重叠加：影响最大，吉凶最明显
- 双重叠加：影响较大
- 单一四化：基础影响

---

### 2.5 大限流年

#### 2.5.1 大限计算
**大限起算**:
```
阳男阴女：从命宫顺行
  1-10岁在命宫
  11-20岁在兄弟宫
  21-30岁在夫妻宫
  ...

阴男阳女：从命宫逆行
  1-10岁在命宫
  11-20岁在父母宫
  21-30岁在福德宫
  ...
```

**大限宫位**:
- 每个大限有其所在的十二宫位
- 该宫位的星曜、四化影响该10年运势

#### 2.5.2 流年计算
**流年宫位**:
- 流年从命宫起算
- 根据岁数确定流年所在宫位
- 流年宫位影响当年运势

**流年星曜**:
- 流年斗君
- 流年太岁
- 流年博士十二神煞

---

### 2.6 界面展示

#### 2.6.1 紫微盘布局
**命盘结构**:
```
┌────────┬────────┬────────┬────────┐
│  巳宫  │  午宫  │  未宫  │  申宫  │
│        │        │        │        │
├────────┼────────┼────────┼────────┤
│  辰宫  │                 │  酉宫  │
│        │   命盘信息      │        │
├────────┼────────┼────────┼────────┤
│  卯宫  │                 │  戌宫  │
│        │   中央区域      │        │
├────────┼────────┼────────┼────────┤
│  寅宫  │  丑宫  │  子宫  │  亥宫  │
│        │        │        │        │
└────────┴────────┴────────┴────────┘
```

**宫位内容**:
```
━━━━━━━━━━━━━━━━━━
       子宫（命宫）
━━━━━━━━━━━━━━━━━━
主星: 紫微(禄)  天府
辅星: 左辅  右弼  文昌
煞星: 擎羊
四化: 化禄 化权
━━━━━━━━━━━━━━━━━━
地支: 子  天干: 壬
大限: 21-30岁
━━━━━━━━━━━━━━━━━━
```

#### 2.6.2 星曜显示规则
**主星**:
- 字体较大（14-16px）
- 五行配色或庙旺配色
- 置顶显示

**辅星**:
- 字体适中（11-13px）
- 分类排列（吉星/煞星）

**四化标记**:
- 化禄：红色"禄"标签
- 化权：蓝色"权"标签
- 化科：绿色"科"标签
- 化忌：黑色"忌"标签
- 自化：特殊标记，如"(自化禄)"

#### 2.6.3 大限流年显示
**方式一：下方时间轴**
```
[1-10岁] [11-20岁] [21-30岁] ...
```
点击某个大限，高亮对应宫位

**方式二：右侧面板**
- 显示当前大限信息
- 显示当前流年信息
- 可切换查看其他大限

---

## 三、技术实现

### 3.1 核心算法

#### 3.1.1 紫微星安法
```typescript
function getZiweiGong(wuXingJu: number, day: number): number {
  // 根据五行局和日期计算紫微星所在宫位
  // 不同五行局有不同的起始位置
  const base = [2, 3, 4, 5, 6]; // 水二、木三、金四、土五、火六
  const offset = (day - 1) % 12;
  return (base[wuXingJu] + offset) % 12;
}
```

#### 3.1.2 四化计算
```typescript
function getSiHua(tiangan: string): SiHua {
  const sihuaMap: Record<string, SiHua> = {
    '甲': { lu: '廉贞', quan: '破军', ke: '武曲', ji: '太阳' },
    '乙': { lu: '天机', quan: '天梁', ke: '紫微', ji: '太阴' },
    // ...
  };
  return sihuaMap[tiangan];
}
```

#### 3.1.3 自化检测
```typescript
function checkZiHua(gong: Gong): ZiHua | null {
  const gongGan = gong.tiangan;
  const sihua = getSiHua(gongGan);
  const stars = gong.stars;
  
  // 检查宫内主星是否被本宫天干四化
  if (stars.includes(sihua.lu)) return { type: 'lu', star: sihua.lu };
  if (stars.includes(sihua.quan)) return { type: 'quan', star: sihua.quan };
  if (stars.includes(sihua.ke)) return { type: 'ke', star: sihua.ke };
  if (stars.includes(sihua.ji)) return { type: 'ji', star: sihua.ji };
  
  return null;
}
```

### 3.2 数据结构

```typescript
interface ZiweiChart {
  birthInfo: BirthInfo;           // 生辰信息
  wuXingJu: number;               // 五行局
  gongs: Gong[];                  // 十二宫数组
  mingGong: number;               // 命宫位置
  shenGong: number;               // 身宫位置
  benMingSiHua: SiHua;            // 本命四化
  daXian: DaXian[];               // 大限数组
}

interface Gong {
  position: number;               // 宫位（0-11）
  name: string;                   // 宫位名称
  dizhi: string;                  // 地支
  tiangan: string;                // 天干
  mainStars: string[];            // 主星
  auxStars: string[];             // 辅星
  shaStars: string[];             // 煞星
  sihua: SiHuaInfo[];             // 四化信息
  zihua: ZiHua | null;            // 自化
  daxianAge?: string;             // 大限岁数
}

interface SiHua {
  lu: string;    // 化禄星
  quan: string;  // 化权星
  ke: string;    // 化科星
  ji: string;    // 化忌星
}

interface SiHuaInfo {
  star: string;       // 星曜名称
  type: 'lu' | 'quan' | 'ke' | 'ji';  // 四化类型
  source: 'benming' | 'daxian' | 'liunian';  // 来源
}

interface DaXian {
  startAge: number;   // 起始岁数
  endAge: number;     // 结束岁数
  gongPosition: number;  // 所在宫位
  sihua: SiHua;       // 该大限的四化
}
```

---

## 四、已实现功能

### 4.1 完整安星体系
- ✅ 14主星准确安排
- ✅ 六吉星、六煞星安排
- ✅ 禄存、天马等辅星
- ✅ 100+辅星全部实现

### 4.2 四化系统
- ✅ 本命四化
- ✅ 大限四化
- ✅ 流年四化
- ✅ 自化检测
- ✅ 四化叠加显示

### 4.3 大限流年
- ✅ 大限计算（阳男阴女、阴男阳女）
- ✅ 流年计算
- ✅ 大限宫位高亮
- ✅ 流年宫位显示

### 4.4 界面展示
- ✅ 十二宫格布局
- ✅ 星曜分类显示
- ✅ 四化标签标记
- ✅ 自化特殊标记
- ✅ 大限流年时间轴

---

## 五、测试验证

### 5.1 安星准确性测试
- [x] 紫微星位置
- [x] 天府星位置
- [x] 14主星位置
- [x] 辅星位置
- [x] 煞星位置

### 5.2 四化准确性测试
- [x] 本命四化
- [x] 大限四化
- [x] 流年四化
- [x] 自化检测
- [x] 四化叠加

### 5.3 对比验证
**参考工具**: 传统紫微斗数排盘软件
**验证项目**: 
- 命盘星曜位置 ✅
- 四化标记 ✅
- 大限流年 ✅

---

## 六、已知问题与限制

### 6.1 已知问题
- 无

### 6.2 功能限制
1. **星曜解释**: 当前未实现星曜含义解释功能
2. **自动分析**: 未实现自动命盘分析功能
3. **格局判断**: 未实现格局（如紫府同宫、廉贞破军等）自动判断

---

## 七、后续优化计划

### 7.1 短期优化
- [ ] 添加星曜悬停提示（显示星曜含义）
- [ ] 优化四化标签样式
- [ ] 添加星曜庙旺陷落标记

### 7.2 中期优化
- [ ] 实现格局自动识别
- [ ] 添加命盘简要分析
- [ ] 支持打印和导出

### 7.3 长期优化
- [ ] AI智能命盘分析
- [ ] 流年大运吉凶预测
- [ ] 命盘对比分析（合婚等）

---

## 八、大限流年详细说明

### 8.1 纳音五行局计算规则

#### 命宫干支决定五行局
一张命盘的纳音五行局是由**命宫的天干地支**确定的，不是由出生年份决定。

#### 计算方法
1. **天干配数**：甲乙→1, 丙丁→2, 戊己→3, 庚辛→4, 壬癸→5
2. **地支配数**：子丑午未→1, 寅卯申酉→2, 辰巳戌亥→3
3. **计算五行局**：干支配数相加，若>5则减5，根据结果查表：
   - 1 → 木三局
   - 2 → 金四局
   - 3 → 水二局
   - 4 → 火六局
   - 5 → 土五局

**示例**:
- 丙午：2+1=3 → 水二局
- 戊子：3+1=4 → 火六局

### 8.2 大限起运规则

#### 起运年龄
大限起运年龄由五行局决定：
- 水二局：2岁起运
- 木三局：3岁起运
- 金四局：4岁起运
- 土五局：5岁起运
- 火六局：6岁起运

#### 大限周期
- 每个大限管10年
- 共12个大限（120年）

#### 大限顺序
- **阳男/阴女**：顺行（顺时针）
  命宫 → 父母 → 福德 → 田宅 → 官禄 → 奴仆 → 迁移 → 疾厄 → 财帛 → 子女 → 夫妻 → 兄弟
- **阴男/阳女**：逆行（逆时针）
  命宫 → 兄弟 → 夫妻 → 子女 → 财帛 → 疾厄 → 迁移 → 奴仆 → 官禄 → 田宅 → 福德 → 父母

### 8.3 流年显示逻辑

#### 流年范围
显示当前大限的完整10年流年

**示例**:
- 当前在第2大限12~21岁
- 出生于2014年
- 则显示：2025年~2034年（12岁~21岁对应的10年）

#### 流年分配规则
流年年份按地支固定分配：
- 子年（如2020）→ 子宫
- 丑年（如2021）→ 丑宫
- 寅年（如2022）→ 寅宫
- ...依次类推

---

## 九、相关文档

### 需求文档
- [八字排盘功能需求文档](./requirement_bazi_chart.md)
- [快捷录入排盘功能需求文档](./requirement_bazi_quick_input.md)

### 紫微斗数详细文档
- [紫微斗数完整系统文档](./ziwei_complete_system.md)
- [紫微斗数技术规范](./ziwei_tech_spec.md)
- [紫微安星方法详解](./ziwei_anxing_method.md)
- [紫微辅星方法详解](./ziwei_auxstar_method.md)

### 实现总结
- [四化大限逻辑总结](./sihua_daxian_summary.md)
- [大限流年逻辑说明](./daxian_liunian_logic.md)
- [自化逻辑修正总结](./zihua_logic_fix_summary.md)
- [飞化交互实现总结](./feihua_interaction_summary.md)

---

## 十、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2024-12-05 | 初始版本，整合紫微斗数所有需求 |
| 1.1 | 2024-12-05 | 添加四化系统详细说明 |
| 1.2 | 2024-12-06 | 补充大限流年详细逻辑，整合相关文档链接 |
| 1.2 | 2024-12-05 | 完善自化逻辑和测试用例 |
